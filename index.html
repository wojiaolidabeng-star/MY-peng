<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>李医生数字诊室</title>
    <!-- 引入 Coze SDK -->
    <script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js"></script>
    <!-- 引入 jsrsasign 用于生成 JWT -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            display: flex;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* 左侧海报区域 - 75% 宽度 */
        .left-poster {
            width: 75%;
            height: 100%;
            overflow: hidden;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .left-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center right;
        }

        /* 右侧对话框区域 - 由 Coze SDK 自动占据 */
        .coze-web-sdk-container {
            right: 0 !important;
            bottom: 0 !important;
            left: auto !important;
            top: 0 !important;
            width: 25% !important;
            height: 100% !important;
            z-index: 1000 !important;
        }

        /* 隐藏气泡按钮 */
        .coze-web-sdk-bubble-icon {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- 左侧海报 -->
    <div class="left-poster">
        <img src="https://images.unsplash.com/photo-1629909613654-28e377c37b09?q=80&w=2070&auto=format&fit=crop" alt="诊室预览">
    </div>

    <script>
        // ============================================
        // 配置区域
        // ============================================
        const COZE_CONFIG = {
            botId: '7608863077597626394',
            appId: '98413940235942673107639473050914.app.coze',
            publicKey: 'Lz_Ovr855eHfMWrxvaSoas97mnDfXakqemD2LWmTnmc',
            privateKey: `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDENzcVeH36ImNL
8DkoXUJzyR2bkqSVkdutszpjmBH4ZT8MwTXKp8iS8LFatIXXeDqvhtK3kwm22kwx
WjZaC2I7/c8QQQRiD9+yZRr128s61To1iGwXG1rE1HIUnypuoJmfxOXEfcyoYGRK
7Z/zL1Kc6DmE/kL4MKUXaGP2/YFdYOhqlkUEcVQ3H0/4XUvQ99hpQp/zFnFJ6x+g
ykQKc4+LmCggPnZkagYT4oZgmhA9rT/5xYF4T4WE4p5ZXy1Qqe7uhbaMM4CxfXR4
6s4MvcUoJyckSn7TH/lZXqmpSjScezDbg/W/DW9zT1yrrAKtkB53VKp5l1kXBRF2
jpCf0zhVAgMBAAECggEAA9v/9+qxpz62ApUdxrFSgInRsx221SAakk4FBYorVlFF
fkGubKDd66TGbd3A1GL8XB36g8GL+1FlYylRvULEKQc3vRHbHUOpkOFD671dDLhY
QTVm+auTa21jT6XTm5WKMZyMyWkRCLUAQmhuN2x0aa4rc9x3CQzJ5OefSbxYQLPB
rKuc87IwZQUYenayFNntfDCw08fqZeM0ONVdj9LYGNTWyQOIrO1M9XS8OV+rvZdj
AmjC13n58F/iS8AFpTjjlcNowgwyfgH44cxlsQFtFdsc4DySTgF1QuY2bLfoTPSm
bywBrjJuKhMLShUwSpko2s2JyFucsNnffi5wT0SdEQKBgQDwd00BqjkBB2EACd4O
Y4CRlL87XJ0uYfoveLdKPAmILZVDMMUxFaUSZvhuIRdM9YkCYq5glEUsgImfDW5y
ACxe6g+SfVOMzNiEN4D7pmqwV+qGpOdBA56Pf7/O0sD9cdmyZq78c91EUhaed8r0
x0xWD20ocZzD4zMV6QzMrgmGEQKBgQDQ5CA4BU1eN3sMU+e9+CnYy2cKNmJtUMeP
C6/08+r2ioT4pUEwe5ZVlPcG+nhNzMxU/E+CeSwiwCAa++wqNiPQzxH0dpcoztr/
krZzvQm2PFfEx/wh18ZF8UdKBpRzxn+nvXXTeG0Yblg8z+aAPl8jif6lsJkDT7C/
sfFl3kf6BQKBgCTsPJ/H0m7tAiDuYvFUp/Yyn9Zulxf7JV5Kq+IzK8eEMEob3/t0
dl9H/ldyr1A612nNWzcrLR/zMK6CcnYAvs9oIzH8GmshPRG4MA7z86fWKAW6pmOe
OaeRFxOb2tRPufyhtba/17bY3+4/OKOzQm5oeftezpJpfXucyEFZa87xAoGBAMot
sj1mbF6fZjolT6wfcClDnURWJOfXAn8h+bklCCp9IXwjPjg1tei5WGpprFzotnAf
ELmgnCY6PBjB8e9dHUcx1Bf/XAiERZSNpIfa1HaMawqr4Q3EcUQq5ivwuGhiHBX3
Gv6FlVnLGx4ovtkrBRw5qL0ncsGwtMqk6JcHEDUdAoGAApiaWc4o2pSraICGTrbG
0phDqeBG8K8Ve7CZ4G6Uv26DCjaJ/WO0aDtkyCxg/+8y9+0pptKyxhXsCuWv3Gtt
svCUgjW8HFsL+DS5Fgguy0TRTPwTEUX0JTMgJfbBQ1CUcueJ9F4q4j39FYfNAZZQ
XcJOBW3DpsqgvLGvIpLK/6E=
-----END PRIVATE KEY-----`
        };

        // ============================================
        // 会话管理：为每个用户生成唯一 ID
        // ============================================
        let userSessionId = localStorage.getItem('dr_chatbot_session_id');

        if (!userSessionId) {
            // 首次访问，生成新的会话 ID
            userSessionId = 'patient_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('dr_chatbot_session_id', userSessionId);
        }

        console.log('=== 李医生数字诊室 ===');
        console.log('会话ID (session_name):', userSessionId);

        // ============================================
        // 生成 JWT Token
        // ============================================
        function generateCozeJwt() {
            const header = {
                alg: 'RS256',
                typ: 'JWT',
                kid: COZE_CONFIG.publicKey
            };

            const currentTime = Math.floor(Date.now() / 1000);
            const payload = {
                iss: COZE_CONFIG.appId,
                aud: 'api.coze.cn',
                jti: Math.random().toString(36).substr(2, 32) + Date.now(),
                iat: currentTime,
                exp: currentTime + 3600,  // Token 有效期 1 小时
                session_name: userSessionId  // 【关键】会话隔离的核心！
            };

            return KJUR.jws.JWS.sign(
                header.alg,
                JSON.stringify(header),
                JSON.stringify(payload),
                COZE_CONFIG.privateKey
            );
        }

        // ============================================
        // 初始化 Coze SDK
        // ============================================
        const client = new CozeWebSDK.WebChatClient({
            config: {
                bot_id: COZE_CONFIG.botId
            },
            componentProps: {
                title: '李医生数字诊室',
                layout: 'pc'
            },
            auth: {
                type: 'jwt_token',  // 使用 JWT 认证
                token: generateCozeJwt(),
                onRefreshToken: () => {
                    console.log('Token 刷新');
                    return generateCozeJwt();
                }
            },
            userInfo: {
                id: userSessionId,
                name: '患者'
            },
            ui: {
                asstBtn: {
                    isNeed: false  // 隐藏按钮
                }
            }
        });

        // ============================================
        // 自动打开对话框
        // ============================================
        setTimeout(() => {
            if (client.showChatBot) {
                client.showChatBot();
                console.log('✅ 对话框已打开');
            }
        }, 1000);
    </script>
</body>
</html>
